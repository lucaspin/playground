on:
  workflow_dispatch:
    inputs:
      superplane_execution_id:
        description: 'Superplane Execution ID'
        required: true
        type: string
      commit_sha:
        description: 'Commit SHA'
        required: false
        type: string
        default: "whatever"
permissions:
  id-token: write
name: Task
run-name: "Task - ${{ inputs.superplane_execution_id }}"
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Install OIDC Client from Core Package
        run: npm install @actions/core@1.6.0 @actions/http-client
      - name: Get Id Token
        uses: actions/github-script@v7
        id: idToken
        with:
          script: |
            let token = await core.getIDToken('superplane')
            core.setOutput('token', token)
      - run: |
          curl -s \
            https://1ba0b3722c7d.ngrok-free.app/api/v1/outputs \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GITHUB_ID_TOKEN" \
            --data "{\"execution_id\":\"$EXECUTION_ID\",\"external_id\":\"$GITHUB_RUN_ID\",\"outputs\":{\"OUTPUT_1\":\"$(openssl rand -hex 8)\"}}"
        env:
          COMMIT_SHA: ${{ inputs.commit_sha }}
          EXECUTION_ID: ${{ inputs.superplane_execution_id }}
          GITHUB_ID_TOKEN: ${{ steps.idToken.outputs.token }}
